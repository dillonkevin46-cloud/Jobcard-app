{% extends 'base.html' %}

{% block title %}Template Builder - ServiceForge Pro{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.form.io/formiojs/formio.full.min.css">
<script src="https://cdn.form.io/formiojs/formio.full.min.js"></script>

<style>
    /* A4 Document Styling */
    #builder-wrapper {
        background-color: #f3f4f6;
        padding: 2rem;
        display: flex;
        justify-content: center;
    }
    #document-canvas {
        background-color: white;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        width: 210mm;
        min-height: 297mm;
        padding: 20mm;
        position: relative;
    }
    .formio-builder-form {
        position: relative;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-3xl font-bold text-gray-800">Jobcard Designer</h2>
        <p class="text-gray-500 mt-1">Drag and drop Jobcard blocks onto the document.</p>
    </div>
    <form id="templateForm" method="POST" class="flex space-x-4">
        {% csrf_token %}
        <input type="text" name="name" value="{{ template.name|default:'' }}" placeholder="Template Name (e.g., Standard Fix)" class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
        <input type="hidden" name="layout_schema" id="layout_schema">
        <button type="button" id="saveTemplateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
            <i class="fas fa-save mr-2"></i> Save Template
        </button>
    </form>
</div>

<div id="builder-wrapper">
    <div id="document-canvas">
        <div id="builder"></div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Load existing schema if editing, otherwise empty object
    const existingSchema = {{ schema_json|safe|default:"{}" }};

    // Initialize Form.io Builder
    Formio.builder(document.getElementById('builder'), existingSchema, {
        builder: {
            basic: false,
            advanced: false,
            data: false,
            premium: false,
            layout: false,
            jobcardBlocks: {
                title: 'Jobcard Blocks',
                default: true,
                weight: 0,
                components: {
                    logo: {
                        title: 'Header Logo',
                        key: 'logo',
                        icon: 'image',
                        schema: {
                            label: 'Logo',
                            type: 'htmlelement',
                            tag: 'img',
                            attrs: [
                                { attr: 'src', value: 'https://via.placeholder.com/250x100?text=Upload+Logo+Here' },
                                { attr: 'style', value: 'max-width: 100%; height: auto; margin-bottom: 20px;' }
                            ]
                        }
                    },
                    address: {
                        title: 'Address Block',
                        key: 'address',
                        icon: 'home',
                        schema: {
                            label: 'Company Address',
                            type: 'textarea',
                            key: 'companyAddress',
                            defaultValue: '123 Service Road\nCity, Country\nPhone: 555-0100',
                            rows: 3
                        }
                    },
                    jobcardId: {
                        title: 'Jobcard Number',
                        key: 'jobcardId',
                        icon: 'hashtag',
                        schema: {
                            label: 'Jobcard ID',
                            type: 'textfield',
                            key: 'jobcard_id',
                            disabled: true,
                            defaultValue: 'JC-YYYY-XXXX'
                        }
                    },
                    timeLog: {
                        title: 'Time Log',
                        key: 'timeLog',
                        icon: 'clock-o',
                        schema: {
                            label: 'Time Log',
                            type: 'columns',
                            key: 'timeColumns',
                            columns: [
                                { components: [{ type: 'datetime', key: 'startTime', label: 'Start Time', enableTime: true }] },
                                { components: [{ type: 'datetime', key: 'endTime', label: 'End Time', enableTime: true }] }
                            ]
                        }
                    },
                    lineItems: {
                        title: 'Work Completed (Grid)',
                        key: 'lineItems',
                        icon: 'list',
                        schema: {
                            label: 'Work Completed',
                            type: 'datagrid',
                            key: 'workItems',
                            components: [
                                { type: 'textfield', key: 'whoHelped', label: 'Who was helped' },
                                { type: 'textfield', key: 'hardware', label: 'Hardware Used' },
                                { type: 'number', key: 'qty', label: 'Quantity' }
                            ]
                        }
                    },
                    signatures: {
                        title: 'Signatures',
                        key: 'signatures',
                        icon: 'pencil',
                        schema: {
                            label: 'Signatures',
                            type: 'columns',
                            key: 'signatureColumns',
                            columns: [
                                { components: [{ type: 'signature', key: 'clientSignature', label: 'Client Signature', footer: 'Sign above' }] },
                                { components: [{ type: 'signature', key: 'techSignature', label: 'Technician Signature', footer: 'Sign above' }] }
                            ]
                        }
                    },
                    watermark: {
                        title: 'Watermark',
                        key: 'watermark',
                        icon: 'stamp',
                        schema: {
                            label: 'Watermark',
                            type: 'htmlelement',
                            tag: 'div',
                            content: 'SERVICEFORGE PRO',
                            attrs: [
                                { attr: 'style', value: 'position: absolute; top: 40%; left: 10%; opacity: 0.1; font-size: 80px; transform: rotate(-45deg); pointer-events: none; z-index: 0;' }
                            ]
                        }
                    }
                }
            }
        }
    }).then(function(builder) {
        // Handle Save Button Click
        document.getElementById('saveTemplateBtn').addEventListener('click', function() {
            // Get the schema string from the builder
            const schemaString = JSON.stringify(builder.schema);
            // Place it in the hidden input
            document.getElementById('layout_schema').value = schemaString;
            // Submit the Django form
            document.getElementById('templateForm').submit();
        });
    });
});
</script>
{% endblock %}
