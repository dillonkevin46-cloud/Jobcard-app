{% extends 'base.html' %}

{% block title %}Jobcard Template Builder - ServiceForge Pro{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdn.form.io/formiojs/formio.full.min.css">
    <script src="https://cdn.form.io/formiojs/formio.full.min.js"></script>
    <style>
        #builder {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            max-width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 120px;
            color: rgba(200, 200, 200, 0.2);
            font-weight: bold;
            z-index: 0;
            pointer-events: none;
            text-transform: uppercase;
        }

        /* Ensure form components sit above the watermark */
        .formio-component {
            position: relative;
            z-index: 10;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="max-w-7xl mx-auto">
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">Jobcard Document Designer</h2>
                <p class="text-gray-500 mt-1">Design your A4 jobcard layout using custom blocks.</p>
            </div>
            <div>
                <a href="{% url 'template_list' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-3 transition-colors duration-200">
                    Cancel
                </a>
                <button type="button" id="saveTemplate" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors duration-200">
                    <i class="fas fa-save mr-2"></i> Save Template
                </button>
            </div>
        </div>

        <form method="POST" id="templateForm" class="space-y-6">
            {% csrf_token %}
            <input type="hidden" name="layout_schema" id="layout_schema">

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                <input type="text" name="name" id="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. Standard Service Jobcard" value="{{ template.name|default:'' }}">
            </div>

            <!-- The A4 Builder Area -->
            <div class="bg-gray-100 p-8 rounded-xl border border-gray-200 overflow-auto">
                <div id="builder">
                    <div class="watermark">ServiceForge</div>
                </div>
            </div>
        </form>
    </div>

    <script>
        window.onload = function() {
            const existingSchema = {{ schema_json|safe|default:"{}" }};

            Formio.builder(document.getElementById('builder'), existingSchema, {
                builder: {
                    basic: false, advanced: false, data: false, premium: false, layout: false,
                    jobcardBlocks: {
                        title: 'Jobcard Blocks',
                        weight: 0,
                        components: {
                            logo: {
                                title: 'Header Logo', key: 'logo', icon: 'image',
                                schema: { type: 'htmlelement', tag: 'img', attrs: [{attr: 'src', value: 'https://via.placeholder.com/200x50?text=Company+Logo'}], className: 'mb-4' }
                            },
                            address: {
                                title: 'Address Block', key: 'address', icon: 'home',
                                schema: { label: 'Company Address', type: 'textarea', key: 'addressBlock', defaultValue: '123 Service Road\nCity, Country\nPhone: 555-0100', rows: 3 }
                            },
                            jobcardId: {
                                title: 'Jobcard Number', key: 'jobcardId', icon: 'hashtag',
                                schema: { label: 'Jobcard ID', type: 'textfield', key: 'jobcard_id', disabled: true, placeholder: 'Auto-generated' }
                            },
                            timeLog: {
                                title: 'Time Log', key: 'timeLog', icon: 'clock-o',
                                schema: { label: 'Start Time', type: 'datetime', key: 'startTime', enableTime: true }
                            },
                            lineItems: {
                                title: 'Line Items Grid', key: 'lineItems', icon: 'list',
                                schema: {
                                    label: 'Work Done', type: 'datagrid', key: 'lineItems',
                                    components: [
                                        {label: 'Who was helped', key: 'whoHelped', type: 'textfield', input: true},
                                        {label: 'Hardware Used', key: 'hardware', type: 'textfield', input: true},
                                        {label: 'Qty', key: 'qty', type: 'number', input: true}
                                    ]
                                }
                            },
                            signatures: {
                                title: 'Signature Pad', key: 'signatures', icon: 'pencil',
                                schema: { label: 'Signature', type: 'signature', key: 'signatureBox', hideLabel: false }
                            }
                        }
                    }
                }
            }).then(function(builder) {
                document.getElementById('saveTemplate').addEventListener('click', function() {
                    document.getElementById('layout_schema').value = JSON.stringify(builder.schema);
                    document.getElementById('templateForm').submit();
                });
            });
        };
    </script>
{% endblock %}
