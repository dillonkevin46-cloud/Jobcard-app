{% extends 'base.html' %}

{% block title %}Jobcard Template Builder - ServiceForge Pro{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdn.form.io/formiojs/formio.full.min.css">
    <script src="https://cdn.form.io/formiojs/formio.full.min.js"></script>
    <style>
        #builder {
            background-color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 20mm;
            position: relative;
        }

        /* Ensure form components sit above the watermark */
        .formio-component {
            position: relative;
            z-index: 10;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="max-w-7xl mx-auto">
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">Jobcard Document Designer</h2>
                <p class="text-gray-500 mt-1">Design your A4 jobcard layout using custom blocks.</p>
            </div>
            <div>
                <a href="{% url 'template_list' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-3 transition-colors duration-200">
                    Cancel
                </a>
                <button type="button" id="saveTemplate" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors duration-200">
                    <i class="fas fa-save mr-2"></i> Save Template
                </button>
            </div>
        </div>

        <form method="POST" id="templateForm" class="space-y-6">
            {% csrf_token %}
            <input type="hidden" name="layout_schema" id="layout_schema">

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                <input type="text" name="name" id="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. Standard Service Jobcard" value="{{ template.name|default:'' }}">
            </div>

            <!-- The A4 Builder Area -->
            <div class="bg-gray-100 p-8 rounded-xl border border-gray-200 overflow-auto">
                <div id="builder"></div>
            </div>
        </form>
    </div>

    <script>
        window.onload = function() {
            const existingSchema = {{ schema_json|safe|default:"{}" }};

            Formio.builder(document.getElementById('builder'), existingSchema, {
                builder: {
                    basic: false,
                    advanced: false,
                    data: false,
                    premium: false,
                    layout: false,
                    custom: false,
                    resource: false,
                    jobcardBlocks: {
                        title: 'Jobcard Blocks',
                        weight: 0,
                        default: true,
                        components: {
                            headerlogo: {
                                title: 'Header Logo',
                                key: 'headerLogo',
                                icon: 'image',
                                schema: {
                                    label: 'Header Logo',
                                    key: 'headerLogo',
                                    type: 'file',
                                    image: true,
                                    storage: 'base64',
                                    input: true,
                                    tableView: true
                                }
                            },
                            companyaddress: {
                                title: 'Company Address',
                                key: 'companyAddress',
                                icon: 'home',
                                schema: {
                                    label: 'Company Address',
                                    key: 'companyAddress',
                                    type: 'textarea',
                                    defaultValue: 'Your Company Name\n123 Service Street\nCity, Country\nPhone: (555) 123-4567',
                                    rows: 4,
                                    input: true,
                                    tableView: true
                                }
                            },
                            jobcardnumber: {
                                title: 'Jobcard Number',
                                key: 'jobcardNumber',
                                icon: 'hashtag',
                                schema: {
                                    label: 'Jobcard ID',
                                    key: 'jobcard_id',
                                    type: 'textfield',
                                    input: true,
                                    placeholder: 'JC-YYYY-XXXX',
                                    disabled: true,
                                    tableView: true
                                }
                            },
                            timetracking: {
                                title: 'Time Tracking',
                                key: 'timeTracking',
                                icon: 'clock-o',
                                schema: {
                                    label: 'Time Tracking',
                                    columns: [
                                        {
                                            components: [
                                                {
                                                    label: 'Start Time',
                                                    key: 'startTime',
                                                    type: 'datetime',
                                                    input: true,
                                                    enableDate: true,
                                                    enableTime: true,
                                                    tableView: true
                                                }
                                            ],
                                            width: 6,
                                            offset: 0,
                                            push: 0,
                                            pull: 0
                                        },
                                        {
                                            components: [
                                                {
                                                    label: 'End Time',
                                                    key: 'endTime',
                                                    type: 'datetime',
                                                    input: true,
                                                    enableDate: true,
                                                    enableTime: true,
                                                    tableView: true
                                                }
                                            ],
                                            width: 6,
                                            offset: 0,
                                            push: 0,
                                            pull: 0
                                        }
                                    ],
                                    type: 'columns',
                                    input: false,
                                    tableView: false
                                }
                            },
                            techlineitems: {
                                title: 'Tech Line Items',
                                key: 'techLineItems',
                                icon: 'list',
                                schema: {
                                    label: 'Work Completed',
                                    key: 'workCompleted',
                                    type: 'datagrid',
                                    input: true,
                                    tableView: true,
                                    components: [
                                        {
                                            label: 'Who was helped',
                                            key: 'whoHelped',
                                            type: 'textfield',
                                            input: true,
                                            tableView: true
                                        },
                                        {
                                            label: 'Hardware Used',
                                            key: 'hardwareUsed',
                                            type: 'textfield',
                                            input: true,
                                            tableView: true
                                        },
                                        {
                                            label: 'Quantity',
                                            key: 'quantity',
                                            type: 'number',
                                            input: true,
                                            tableView: true,
                                            defaultValue: 1
                                        }
                                    ]
                                }
                            },
                            signatures: {
                                title: 'Signatures',
                                key: 'signatures',
                                icon: 'pencil',
                                schema: {
                                    label: 'Signatures',
                                    columns: [
                                        {
                                            components: [
                                                {
                                                    label: 'Client Signature',
                                                    key: 'clientSignature',
                                                    type: 'signature',
                                                    input: true,
                                                    tableView: true,
                                                    footer: 'Signed by Client'
                                                }
                                            ],
                                            width: 6,
                                            offset: 0,
                                            push: 0,
                                            pull: 0
                                        },
                                        {
                                            components: [
                                                {
                                                    label: 'Technician Signature',
                                                    key: 'technicianSignature',
                                                    type: 'signature',
                                                    input: true,
                                                    tableView: true,
                                                    footer: 'Signed by Technician'
                                                }
                                            ],
                                            width: 6,
                                            offset: 0,
                                            push: 0,
                                            pull: 0
                                        }
                                    ],
                                    type: 'columns',
                                    input: false,
                                    tableView: false
                                }
                            },
                            watermark: {
                                title: 'Watermark',
                                key: 'watermark',
                                icon: 'stamp',
                                schema: {
                                    label: 'Watermark',
                                    tag: 'div',
                                    content: 'ServiceForge',
                                    attrs: [
                                        {
                                            attr: 'style',
                                            value: 'position: absolute; top: 30%; left: 10%; opacity: 0.1; font-size: 80px; transform: rotate(-45deg); pointer-events: none; font-weight: bold; color: gray;'
                                        }
                                    ],
                                    type: 'htmlelement',
                                    input: false,
                                    persistent: false
                                }
                            }
                        }
                    }
                }
            }).then(function(builder) {
                document.getElementById('saveTemplate').addEventListener('click', function() {
                    document.getElementById('layout_schema').value = JSON.stringify(builder.schema);
                    document.getElementById('templateForm').submit();
                });
            });
        };
    </script>
{% endblock %}
